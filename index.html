<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Simulateur FIRE – VT & Retraits</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg-gradient: radial-gradient(circle at top left, #020617 0%, #020617 40%, #020617 100%);
      --card-bg: rgba(15, 23, 42, 0.92);
      --border-glow: rgba(56, 189, 248, 0.5);
      --accent: #22d3ee;
      --accent-soft: rgba(34, 211, 238, 0.15);
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --danger: #fb7185;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg-gradient);
      color: var(--text-main);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }

    h1 {
      font-size: 1.8rem;
      margin: 0 0 4px;
      text-align: center;
      letter-spacing: .03em;
    }

    h1 span {
      background: linear-gradient(120deg, #22d3ee, #a855f7);
      -webkit-background-clip: text;
      color: transparent;
    }

    .subtitle {
      text-align: center;
      color: var(--text-muted);
      max-width: 640px;
      margin-bottom: 20px;
      font-size: 0.94rem;
    }

    .shell {
      width: 100%;
      max-width: 1180px;
      display: grid;
      grid-template-columns: minmax(0, 340px) minmax(0, 340px) minmax(0, 1fr);
      gap: 16px;
    }

    @media (max-width: 960px) {
      .shell { grid-template-columns: minmax(0, 1fr); }
    }

    .card {
      position: relative;
      background: var(--card-bg);
      border-radius: 16px;
      padding: 12px 14px 14px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.9);
      backdrop-filter: blur(18px);
    }

    .card::before {
      content: "";
      position: absolute;
      inset: -1px;
      border-radius: inherit;
      background: radial-gradient(circle at top, var(--border-glow), transparent 55%);
      opacity: 0.35;
      z-index: -1;
    }

    h2 {
      font-size: 1.02rem;
      margin: 0 0 6px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    h2 span {
      width: 6px;
      height: 18px;
      border-radius: 999px;
      background: linear-gradient(180deg, #22d3ee, #a855f7);
      display: inline-block;
    }

    label {
      display: block;
      margin-top: 8px;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    input[type="number"], select {
      width: 100%;
      margin-top: 3px;
      border-radius: 8px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      padding: 5px 8px;
      background-color: rgba(15, 23, 42, 0.9);
      color: var(--text-main);
      font-size: 0.84rem;
    }

    input[type="number"]:focus, select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent-soft);
    }

    small { color: var(--text-muted); }

    .year-rows {
      max-height: 210px;
      overflow-y: auto;
      margin-top: 4px;
      padding-right: 4px;
    }

    .year-row {
      display: flex;
      gap: 6px;
      margin-top: 4px;
      align-items: center;
    }

    .year-row span {
      width: 52px;
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    .year-row input {
      flex: 1;
      font-size: 0.8rem;
    }

    button {
      margin-top: 10px;
      padding: 7px 12px;
      border-radius: 999px;
      border: none;
      font-size: 0.85rem;
      font-weight: 500;
      color: #020617;
      background: linear-gradient(120deg, #22d3ee, #a855f7);
      cursor: pointer;
      box-shadow: 0 10px 28px rgba(34, 211, 238, 0.4);
      transition: transform 0.08s ease, box-shadow 0.08s ease;
    }

    button:hover { transform: translateY(-1px); }
    button:active { transform: translateY(0); box-shadow: 0 8px 20px rgba(15,23,42,0.8); }

    #chartCard { grid-column: span 3; }
    @media (max-width: 960px) { #chartCard { grid-column: span 1; } }

    #chart {
      width: 100%;
      max-height: 440px;
    }

    #summary {
      margin-top: 8px;
      font-size: 0.88rem;
      color: var(--text-muted);
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 8px;
      border-radius: 999px;
      background-color: rgba(15, 23, 42, 0.85);
      border: 1px solid rgba(148, 163, 184, 0.5);
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 6px;
    }

    .pill-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent);
    }

    .note-danger { color: var(--danger); font-weight: 500; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1><span>Simulateur FIRE</span> – VT & Retraits pour le Costa Rica</h1>
  <p class="subtitle">
    Joue avec les rendements, les versements et les retraits pour visualiser votre trajectoire de capital.
    Idéal pour montrer le plan Costa Rica à ChaCha, sans Excel ni calculatrice.
  </p>

  <div class="shell">
    <div class="card">
      <h2><span></span> Paramètres généraux</h2>
      <label>
        Année de début
        <input id="startYear" type="number" value="2025" />
      </label>
      <label>
        Année de fin
        <input id="endYear" type="number" value="2060" />
      </label>
      <label>
        Taux de rendement annuel (%)
        <input id="rate" type="number" step="0.1" value="5" />
      </label>
      <label>
        Mode de retrait
        <select id="wrMode">
          <option value="percentCurrent">% du capital chaque année (dynamique)</option>
          <option value="percentBase">% du capital à l'année de départ (montant fixe)</option>
        </select>
      </label>
      <label>
        Taux de retrait (%)
        <input id="wr" type="number" step="0.1" value="3.5" />
      </label>
      <label>
        Année de début des retraits
        <input id="wrStart" type="number" value="2043" />
      </label>
      <label>
        Capital initial (CHF)
        <input id="initial" type="number" value="0" />
      </label>

      <div class="pill">
        <span class="pill-dot"></span>
        <span>Astuce : commence avec 5% / 3.5% puis teste 7% pour montrer le potentiel.</span>
      </div>

      <button onclick="runSim()">⚡ Mettre à jour le graphique</button>
    </div>

    <div class="card">
      <h2><span></span> Versements mensuels</h2>
      <p><small>Montant par défaut, puis exceptions par année (laisse vide si pas d'exception).</small></p>
      <label>
        Versement mensuel par défaut (CHF)
        <input id="defaultMonthly" type="number" value="3340" />
      </label>
      <div class="year-rows" id="monthlyYears"></div>
    </div>

    <div class="card">
      <h2><span></span> Versements annuels</h2>
      <p><small>Par ex. 7'500 CHF/an jusqu'en 2039, puis 0 après.</small></p>
      <label>
        Versement annuel par défaut (CHF)
        <input id="defaultAnnual" type="number" value="7500" />
      </label>
      <div class="year-rows" id="annualYears"></div>
    </div>

    <div class="card" id="chartCard">
      <h2><span></span> Courbe du capital</h2>
      <canvas id="chart"></canvas>
      <p id="summary"></p>
      <p><small class="note-danger">Rappel : simulation simplifiée, pas un conseil financier personnalisé.</small></p>
    </div>
  </div>

  <script>
    let chart;

    function buildYearInputs() {
      const startY = parseInt(document.getElementById('startYear').value, 10);
      const endY = parseInt(document.getElementById('endYear').value, 10);
      const monthlyDiv = document.getElementById('monthlyYears');
      const annualDiv = document.getElementById('annualYears');
      monthlyDiv.innerHTML = '';
      annualDiv.innerHTML = '';
      for (let y = startY; y <= endY; y++) {
        const rowM = document.createElement('div');
        rowM.className = 'year-row';
        rowM.innerHTML = `<span>${y}</span><input type="number" step="100" placeholder="mois" data-year="${y}" class="mYear" />`;
        monthlyDiv.appendChild(rowM);

        const rowA = document.createElement('div');
        rowA.className = 'year-row';
        rowA.innerHTML = `<span>${y}</span><input type="number" step="100" placeholder="an" data-year="${y}" class="aYear" />`;
        annualDiv.appendChild(rowA);
      }
    }

    function getMonthlyForYear(year, def) {
      const inputs = document.querySelectorAll('.mYear');
      for (const inp of inputs) {
        if (parseInt(inp.dataset.year, 10) === year && inp.value !== '') {
          return parseFloat(inp.value);
        }
      }
      return def;
    }

    function getAnnualForYear(year, def) {
      const inputs = document.querySelectorAll('.aYear');
      for (const inp of inputs) {
        if (parseInt(inp.dataset.year, 10) === year && inp.value !== '') {
          return parseFloat(inp.value);
        }
      }
      return def;
    }

    function runSim() {
      const startY = parseInt(document.getElementById('startYear').value, 10);
      const endY = parseInt(document.getElementById('endYear').value, 10);
      const rate = parseFloat(document.getElementById('rate').value) / 100.0;
      const wr = parseFloat(document.getElementById('wr').value) / 100.0;
      const wrStart = parseInt(document.getElementById('wrStart').value, 10);
      const wrMode = document.getElementById('wrMode').value;
      const initial = parseFloat(document.getElementById('initial').value) || 0;
      const defM = parseFloat(document.getElementById('defaultMonthly').value) || 0;
      const defA = parseFloat(document.getElementById('defaultAnnual').value) || 0;

      const years = [];
      const vals = [];
      const withdrawals = [];

      let vt = initial;
      const monthlyRate = rate / 12.0;

      // Mode retrait base : calcul du capital à l'année de départ
      let vtWrBase = null;
      if (wrMode === 'percentBase') {
        for (let y = startY; y <= endY; y++) {
          const mContr = getMonthlyForYear(y, defM);
          for (let m = 0; m < 12; m++) {
            vt = vt * (1 + monthlyRate) + mContr;
          }
          const aContr = getAnnualForYear(y, defA);
          vt += aContr;
          if (y === wrStart) {
            vtWrBase = vt;
            break;
          }
        }
        if (vtWrBase === null) {
          alert("L'année de début des retraits doit être comprise entre l'année de début et l'année de fin.");
          return;
        }
      }

      vt = initial;
      let annualWithdrawalBase = vtWrBase ? vtWrBase * wr : null;

      for (let y = startY; y <= endY; y++) {
        const mContr = getMonthlyForYear(y, defM);
        for (let m = 0; m < 12; m++) {
          vt = vt * (1 + monthlyRate) + mContr;
        }
        const aContr = getAnnualForYear(y, defA);
        vt += aContr;

        let thisWithdrawal = 0;
        if (y >= wrStart) {
          if (wrMode === 'percentBase') {
            thisWithdrawal = annualWithdrawalBase;
          } else if (wrMode === 'percentCurrent') {
            thisWithdrawal = vt * wr;
          }
          vt -= thisWithdrawal;
        }

        withdrawals.push(thisWithdrawal);
        years.push(y);
        vals.push(vt);
      }

      const ctx = document.getElementById('chart').getContext('2d');
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: years,
          datasets: [
            {
              label: 'Capital (kCHF)',
              data: vals.map(v => v / 1000.0),
              borderColor: 'rgba(56, 189, 248, 1)',
              backgroundColor: 'rgba(56, 189, 248, 0.08)',
              tension: 0.2,
              fill: true,
            },
            {
              label: 'Retrait annuel (kCHF)',
              data: withdrawals.map(v => v / 1000.0),
              borderColor: 'rgba(148, 163, 184, 1)',
              borderDash: [6, 4],
              pointRadius: 0,
              fill: false,
            },
          ],
        },
        options: {
          responsive: true,
          interaction: { mode: 'index', intersect: false },
          plugins: {
            legend: {
              labels: {
                color: '#e5e7eb',
                font: { size: 11 },
              },
            },
          },
          scales: {
            y: {
              title: { display: true, text: 'kCHF', color: '#9ca3af' },
              ticks: { color: '#9ca3af' },
              grid: { color: 'rgba(55,65,81,0.4)' },
            },
            x: {
              title: { display: true, text: 'Année', color: '#9ca3af' },
              ticks: { color: '#9ca3af' },
              grid: { color: 'rgba(31,41,55,0.5)' },
            },
          },
        },
      });

      const final = vals[vals.length - 1];
      const lastW = withdrawals[withdrawals.length - 1];
      document.getElementById('summary').innerText =
        `Capital en ${endY} : ${final.toFixed(0)} CHF  •  Retrait annuel (dernière année) : ${lastW.toFixed(0)} CHF (~${(lastW/12).toFixed(0)} CHF/mois)`;
    }

    document.getElementById('startYear').addEventListener('change', buildYearInputs);
    document.getElementById('endYear').addEventListener('change', buildYearInputs);
    buildYearInputs();
    window.onload = runSim;
  </script>
</body>
</html>
